# Конвертация моделей

## Примеры
Эта папка содержит примеры того, как конвертировать модели из разных фреймворков в ONNX. Каждая папка состоит из файлов:
1. `model.py` - файл с определением модели и её обучением.
2. `inference.js` - файл с кодом для вывода.
3. `data_generator.py` (необязательно) - файл с кодом для генерации данных. Вся генерация основана на случайных данных с требуемой формой и типом.
4. `/*model_name*` - папка с моделью и её весами.
5. `/*model_name*.onnx` - файл с моделью в формате ONNX.
6. `/data` (необязательно) - папка с сгенерированными данными для модели.
7. `/results` (необязательно) - папка с сохранёнными предсказаниями из созданной модели с файлом 'model.py'.

## Установка

Для запуска примеров вам нужно установить **Python 3.9** или выше и **Node.js v16.16.0** на вашем компьютере.

Установка зависимостей Python с помощью pip:

```bash
cd examples
python3 -m venv venv
source ./venv/bin/activate
pip install -r requirements.txt
```

Установка зависимостей npm:

```bash
npm install
```

### Чтобы запустить пример, вам нужно:

Если он находится в папке:
```bash
python data_generator.py  # Если папка /data уже существует, она будет перезаписана.
```

Затем запустите создание модели, обучение (необязательно), сохранение и конвертацию в ONNX:
```bash
python model.py # Если модель уже существует, она будет перезаписана.
```

И наконец, запустите вывод:
```bash
node inference.js
```
Это запустит основную функцию в `inference.js`, которая загружает модель ONNX, читает тестовые данные из `X_test.json`, выполняет вывод модели и сравнивает результаты с ожидаемыми результатами в `py.json`. Вы увидите результат сравнения в консоли.

## Keras и TensorFlow
Оба фреймворка поддерживаются. Конвертация выполняется с помощью [tf2onnx](https://github.com/onnx/tensorflow-onnx). Хотя Keras2onnx ранее был доступен, он устарел, и его функциональность теперь интегрирована в tf2onnx.

Важно установить эту библиотеку с помощью git, а не pip, чтобы гарантировать наличие последней версии.

```bash
pip install git+https://github.com/onnx/tensorflow-onnx
```

### Поддержка слоев

Все слои, которые могут быть представлены в виде графа с помощью [операторов ONNX](https://github.com/onnx/onnx/blob/main/docs/Operators.md), могут быть конвертированы. Если tf2onnx столкнется с трудностями при конвертации конкретного слоя, может потребоваться ручная реализация. Также стоит проверить наличие обновлений или альтернативных методов в сообществе tf2onnx для улучшенной совместимости.

В ONNX можно создать собственные операторы для TensorFlow, когда нет прямого соответствия между операцией TensorFlow и существующим оператором ONNX. Это позволяет обеспечить большую гибкость и совместимость при конвертации моделей TensorFlow в ONNX. Однако важно отметить, что ONNX Runtime должен поддерживать эти пользовательские операторы для корректного выполнения модели.

Большинство распространённых слоев, используемых в моделях Keras, можно конвертировать в ONNX. Вот некоторые из них:
1. Dense
2. Activation (LeakyReLU, PReLU, ELU, ThresholdedReLU, Softmax, ReLU)
3. Dropout
4. Flatten
5. Input
6. Reshape
7. BatchNormalization
8. Conv1D, Conv2D, Conv3D
9. Add, Subtract, Multiply, Average, Maximum, Minimum, Concatenate, Dot
10. Embedding
11. Conv2DTranspose, Conv3DTranspose
12. MaxPooling1D, MaxPooling2D, MaxPooling3D
13. LSTM, GRU, Bidirectional
14. UpSampling1D, UpSampling2D, UpSampling3D
15. Lambda
16. ZeroPadding1D, ZeroPadding2D, ZeroPadding3D

и многие другие.

## Torch и Sklearn
Все слои, которые могут быть представлены в виде графа с помощью [операторов ONNX](https://github.com/onnx/onnx/blob/main/docs/Operators.md), могут быть конвертированы.
